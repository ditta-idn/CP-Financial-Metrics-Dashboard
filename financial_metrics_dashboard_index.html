<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Financial Metrics Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0b0f17;
      --card: #121826;
      --ink: #e6eaf2;
      --muted: #95a1b6;
      --accent: #4f8cff;
      --accent-2: #7a5cff;
      --ring: rgba(79,140,255,.35);
      --ok: #1bb36b;
      --warn: #f5a524;
      --bad: #ef476f;
      --shadow: 0 8px 30px rgba(0,0,0,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(180deg, #0b0f17 0%, #0d1322 100%);
      color: var(--ink);
    }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 18px; }
    .title h1 { margin: 0; font-size: 26px; font-weight: 700; letter-spacing: .2px; }
    .title small { color: var(--muted); }

    .filters {
      display: grid; gap: 12px; grid-template-columns: repeat(9, minmax(150px, 1fr));
      background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.06);
      padding: 16px; border-radius: 16px; margin-bottom: 20px; box-shadow: var(--shadow);
    }
    @media (max-width: 1200px){ .filters { grid-template-columns: repeat(3, minmax(180px,1fr)); } }
    @media (max-width: 700px){ .filters { grid-template-columns: repeat(2, minmax(160px,1fr)); } }

    label { display: grid; gap: 6px; font-size: 12px; color: var(--muted); }
    select {
      appearance: none; -webkit-appearance: none; -moz-appearance: none;
      background: var(--card); color: var(--ink);
      border: 1px solid rgba(255,255,255,.08); border-radius: 12px;
      padding: 10px 12px; outline: none; box-shadow: inset 0 0 0 1px transparent;
    }
    select:focus { box-shadow: inset 0 0 0 1px var(--ring); border-color: var(--ring); }

    .toolbar { display:flex; gap: 8px; align-items:center; }
    .btn { background: linear-gradient(180deg, #1b2234, #0f1422); color: var(--ink); border: 1px solid rgba(255,255,255,.08);
           padding: 10px 12px; border-radius: 12px; cursor: pointer; }
    .btn:hover { border-color: rgba(255,255,255,.18); }

    .grid { display: grid; gap: 16px; grid-template-columns: repeat(12, 1fr); }
    .card {
      background: var(--card); border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px; padding: 16px; box-shadow: var(--shadow);
    }
    .span-12 { grid-column: span 12; }
    .span-6 { grid-column: span 6; }
    .span-4 { grid-column: span 4; }
    .span-3 { grid-column: span 3; }
    @media (max-width: 1000px){ .span-6, .span-4, .span-3 { grid-column: span 12; } }

    .card h3 { margin: 0 0 8px; font-size: 16px; font-weight: 600; letter-spacing:.2px; }
    .card .sub { color: var(--muted); font-size: 12px; margin-bottom: 8px; }
    .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 12px; }
    .kpis .kpi { background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.06); border-radius: 12px; padding: 12px; }
    .kpis .kpi h4{ margin:0; font-size:12px; color: var(--muted); }
    .kpis .kpi .v{ font-size: 18px; font-weight: 700; margin-top:6px; }

    footer { color: var(--muted); font-size: 12px; margin: 24px 0 8px; text-align:center; }
    canvas { width: 100%; height: 320px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Financial Metrics Dashboard</h1>
        <small id="asOf"></small>
      </div>
      <div class="toolbar">
        <button class="btn" id="resetBtn">Reset filters</button>
      </div>
    </header>

    <!-- Filters -->
    <section class="filters" id="filters">
      <label>By country
        <select id="f_country">
          <option>All</option>
          <option>Indonesia</option>
          <option>Malaysia</option>
          <option>Phillipine</option>
          <option>Thailand</option>
          <option>Vietnam</option>
        </select>
      </label>
      <label>By partner category
        <select id="f_partnerCat">
          <option>All</option>
          <option>VC Partner</option>
          <option>Refferal Others</option>
          <option>AM managed Partners</option>
          <option>Alliance Partner</option>
          <option>Referral partner</option>
          <option>Distribution Partner</option>
          <option>TPI Partner</option>
          <option>Embedded partner</option>
        </select>
      </label>
      <label>By agreement type
        <select id="f_agreement">
          <option>All</option>
          <option>Revenue Sharing</option>
          <option>Non Revenue Sharing</option>
        </select>
      </label>
      <label>By Industry
        <select id="f_industry">
          <option>All</option>
          <option>Digital Product</option>
          <option>Entertainment</option>
          <option>Property</option>
          <option>Financial Service</option>
          <option>Travel&Hospitality</option>
          <option>Non Profit</option>
          <option>Retail</option>
          <option>Services</option>
          <option>Other</option>
        </select>
      </label>
      <label>By CPM
        <select id="f_cpm">
          <option>All</option>
          <option>Charisse</option>
          <option>OT</option>
          <option>Hanna</option>
          <option>Rizki</option>
        </select>
      </label>
      <label>By product
        <select id="f_product">
          <option>All</option>
          <option>VA</option>
          <option>eWallet</option>
          <option>Cards</option>
          <option>Direct Debit</option>
          <option>QR Code</option>
        </select>
      </label>
      <label>By Lead Sales flow
        <select id="f_lead">
          <option>All</option>
          <option>Self Serve</option>
          <option>Sales</option>
          <option>CPM</option>
        </select>
      </label>
      <label>By Marketing activity
        <select id="f_mkt">
          <option>All</option>
          <option>Event campaign</option>
          <option>Campaign</option>
          <option>Non Marketing</option>
        </select>
      </label>
      <label>By merchant age
        <select id="f_age">
          <option>All</option>
          <option>Less than 6 months transacting</option>
          <option>More than 6 months transacting</option>
        </select>
      </label>
    </section>

    <!-- Charts grid -->
    <section class="grid">
      <div class="card span-12">
        <h3>Net revenue vs Target (Current Month – Cumulative MTD)</h3>
        <div class="sub">Lines: Actual, Target (cumulative), Projection (run-rate)</div>
        <div class="kpis">
          <div class="kpi"><h4>MTD Net Rev</h4><div class="v" id="kpi_mtd_net"></div></div>
          <div class="kpi"><h4>Monthly Target (Net)</h4><div class="v" id="kpi_target"></div></div>
          <div class="kpi"><h4>Run-rate Projection</h4><div class="v" id="kpi_proj"></div></div>
          <div class="kpi"><h4>Target Attainment</h4><div class="v" id="kpi_attain"></div></div>
        </div>
        <canvas id="ch_net_vs_target"></canvas>
      </div>

      <div class="card span-6"><h3>Gross revenue – MTD vs prior 3 months</h3><canvas id="ch_gross_trend"></canvas></div>
      <div class="card span-6"><h3>Net revenue – MTD vs prior 3 months</h3><canvas id="ch_net_trend"></canvas></div>
      <div class="card span-6"><h3>Net net revenue – MTD vs prior 3 months</h3><canvas id="ch_netnet_trend"></canvas></div>
      <div class="card span-6"><h3>TPV – MTD vs prior 3 months</h3><canvas id="ch_tpv_trend"></canvas></div>

      <div class="card span-6"><h3>Net Net Margin – MTD vs prior 3 months</h3><canvas id="ch_nnm_trend"></canvas></div>
      <div class="card span-6"><h3>Net Net Margin – 12 months (MoM)</h3><canvas id="ch_nnm_bar"></canvas></div>

      <div class="card span-6"><h3>Net Margin – MTD vs prior 3 months</h3><canvas id="ch_nm_trend"></canvas></div>
      <div class="card span-6"><h3>Net Margin – 12 months (MoM)</h3><canvas id="ch_nm_bar"></canvas></div>

      <div class="card span-6"><h3>Gross Margin – MTD vs prior 3 months</h3><canvas id="ch_gm_trend"></canvas></div>
      <div class="card span-6"><h3>Gross Margin – 12 months (MoM)</h3><canvas id="ch_gm_bar"></canvas></div>
    </section>

    <footer>Mock data for layout only. Replace generator with your data pipeline later.</footer>
  </div>

<script>
// =====================
// Utilities & mock data
// =====================
const now = new Date();
const ASIA_SG_OFFSET_MIN = 8 * 60; // fixed display only
function fmt(num){
  // format currency compact
  return new Intl.NumberFormat('en-SG', {notation:'compact', maximumFractionDigits:1}).format(num);
}
function fmtPct(p){ return (p*100).toFixed(1) + '%'; }
function ymKey(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); }
function daysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function addMonths(d, n){ const dd = new Date(d); dd.setMonth(dd.getMonth()+n); return dd; }
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function pad(n){ return String(n).padStart(2,'0'); }

// Seeded RNG for reproducibility
function mulberry32(a){ return function(){ let t=a += 0x6D2B79F5; t = Math.imul(t ^ t>>>15, t | 1); t ^= t + Math.imul(t ^ t>>>7, t | 61); return ((t ^ t>>>14) >>> 0) / 4294967296; } }
let rng = mulberry32(123456);
function rand(a=0,b=1){ return a + (b-a) * rng(); }
function choice(arr){ return arr[Math.floor(rand(0, arr.length))]; }

// Dimensions
const Countries = ["Indonesia","Malaysia","Phillipine","Thailand","Vietnam"];
const PartnerCats = ["VC Partner","Refferal Others","AM managed Partners","Alliance Partner","Referral partner","Distribution Partner","TPI Partner","Embedded partner"];
const Agreements = ["Revenue Sharing","Non Revenue Sharing"];
const Industries = ["Digital Product","Entertainment","Property","Financial Service","Travel&Hospitality","Non Profit","Retail","Services","Other"];
const CPMs = ["Charisse","OT","Hanna","Rizki"];
const Products = ["VA","eWallet","Cards","Direct Debit","QR Code"];
const LeadFlows = ["Self Serve","Sales","CPM"];
const MktActs = ["Event campaign","Campaign","Non Marketing"];

// Partners mock catalogue
const Partners = Array.from({length: 120}).map((_,i)=>{
  const product = choice(Products);
  const industry = choice(Industries);
  const country = choice(Countries);
  const baseTPV = (
    product === 'Cards' ? rand(400000, 5000000) :
    product === 'eWallet' ? rand(250000, 3000000) :
    product === 'QR Code' ? rand(180000, 1500000) :
    product === 'Direct Debit' ? rand(120000, 900000) :
    rand(150000, 1200000)
  );
  const grossRate = rand(0.006, 0.02);
  const netRate   = Math.max(0.002, grossRate - rand(0.001, 0.006));
  const netNetRate= Math.max(0.001, netRate   - rand(0.0005, 0.004));
  const monthsAgo = Math.floor(rand(0, 16));
  const activation = new Date(now.getFullYear(), now.getMonth()-monthsAgo, 1 + Math.floor(rand(0,25)));
  return {
    id: 'P'+(i+1),
    country, partnerCat: choice(PartnerCats), agreement: choice(Agreements),
    industry, cpm: choice(CPMs), product, lead: choice(LeadFlows), mkt: choice(MktActs),
    activation, baseTPV, grossRate, netRate, netNetRate
  };
});

function seasonalFactor(month, industry){
  // month: 0..11
  let f = 1.0;
  if(industry==='Retail'){
    if(month===10 || month===11) f += 0.18; // Nov/Dec peak
    if(month===0) f -= 0.05; // Jan dip
  }
  if(industry==='Travel&Hospitality'){
    if(month===5 || month===6) f += 0.15; // Jun/Jul
    if(month===1) f -= 0.05;
  }
  if(industry==='Entertainment'){
    if(month===11) f += 0.1;
  }
  return f;
}

// Compute aggregated monthly metrics for last N months for a given filter set
function getFilters(){
  return {
    country: document.getElementById('f_country').value,
    partnerCat: document.getElementById('f_partnerCat').value,
    agreement: document.getElementById('f_agreement').value,
    industry: document.getElementById('f_industry').value,
    cpm: document.getElementById('f_cpm').value,
    product: document.getElementById('f_product').value,
    lead: document.getElementById('f_lead').value,
    mkt: document.getElementById('f_mkt').value,
    age: document.getElementById('f_age').value,
  }
}

function partnerMatches(p, f){
  if(f.country!=='All' && p.country!==f.country) return false;
  if(f.partnerCat!=='All' && p.partnerCat!==f.partnerCat) return false;
  if(f.agreement!=='All' && p.agreement!==f.agreement) return false;
  if(f.industry!=='All' && p.industry!==f.industry) return false;
  if(f.cpm!=='All' && p.cpm!==f.cpm) return false;
  if(f.product!=='All' && p.product!==f.product) return false;
  if(f.lead!=='All' && p.lead!==f.lead) return false;
  if(f.mkt!=='All' && p.mkt!==f.mkt) return false;
  // age filter
  const monthsActive = (now.getFullYear()-p.activation.getFullYear())*12 + (now.getMonth()-p.activation.getMonth()) - (now.getDate()<p.activation.getDate()?1:0);
  if(f.age==='Less than 6 months transacting' && monthsActive>=6) return false;
  if(f.age==='More than 6 months transacting' && monthsActive<6) return false;
  return true;
}

function aggregateMonthly(N=12, filters=getFilters()){
  // returns arrays for last N months ending current month inclusive
  const months = [];
  const monthly = Array.from({length:N}, ()=>({ tpv:0, gross:0, net:0, netnet:0, targetNet:0 }));
  for(let k = N-1; k>=0; k--){
    const d = addMonths(startOfMonth(now), -k);
    months.push({ y: d.getFullYear(), m: d.getMonth(), dim: daysInMonth(d.getFullYear(), d.getMonth()) });
  }
  const selected = Partners.filter(p=>partnerMatches(p, filters));
  // Precompute a per-partner growth baseline
  selected.forEach(p=>{
    months.forEach((mo, idx)=>{
      const monthStart = new Date(mo.y, mo.m, 1);
      if(p.activation > new Date(mo.y, mo.m, daysInMonth(mo.y, mo.m))) return; // not active yet
      const monthsActive = (monthStart.getFullYear()-p.activation.getFullYear())*12 + (monthStart.getMonth()-p.activation.getMonth());
      const growth = Math.min(1 + 0.015*monthsActive, 2.2);
      const season = seasonalFactor(mo.m, p.industry);
      const noise = 0.9 + 0.2*rand();
      const tpv = p.baseTPV * growth * season * noise;
      const gross = tpv * p.grossRate;
      const net   = tpv * p.netRate;
      const netnet= tpv * p.netNetRate;
      monthly[idx].tpv   += tpv;
      monthly[idx].gross += gross;
      monthly[idx].net   += net;
      monthly[idx].netnet+= netnet;
    });
  });

  // Target for current month (simple heuristic: last month net * 1.05)
  for(let i=0;i<monthly.length;i++){
    if(i===monthly.length-1){
      const prev = monthly[i-1]?.net || 0;
      monthly[i].targetNet = prev * 1.05;
    } else {
      monthly[i].targetNet = 0; // not used
    }
  }

  return { months, monthly };
}

function cumulativeByDay(monthValue, y, m){
  const dim = daysInMonth(y,m);
  const arr = [];
  const perDay = monthValue / dim;
  for(let d=1; d<=dim; d++) arr.push(perDay * d);
  return arr;
}

// Build labels for current month MTD
function dayLabels(){
  const d = now; const dim = daysInMonth(d.getFullYear(), d.getMonth());
  return Array.from({length: dim}, (_,i)=> String(i+1));
}

// =====================
// Charts setup
// =====================
const charts = {};

function buildCharts(){
  const ctx = (id)=> document.getElementById(id).getContext('2d');
  // Common options
  const lineOpts = {
    responsive: true, maintainAspectRatio: false,
    interaction: { mode:'index', intersect:false },
    plugins: {
      legend: { labels: { color: '#c7d2e1' } },
      tooltip: { callbacks: { label: (c)=> `${c.dataset.label}: ${fmt(c.parsed.y)}` } }
    },
    scales: {
      x: { ticks: { color:'#9fb1cc' }, grid: { color:'rgba(255,255,255,.06)' } },
      y: { ticks: { color:'#9fb1cc', callback:(v)=> fmt(v) }, grid: { color:'rgba(255,255,255,.06)' } }
    }
  };
  const pctLineOpts = JSON.parse(JSON.stringify(lineOpts));
  pctLineOpts.plugins.tooltip.callbacks.label = (c)=> `${c.dataset.label}: ${fmtPct(c.parsed.y)}`;
  pctLineOpts.scales.y.ticks.callback = (v)=> (v*100)+'%';

  const barOpts = {
    responsive: true, maintainAspectRatio:false,
    plugins: { legend: {display:false}, tooltip: { callbacks: { label:(c)=> fmtPct(c.parsed.y) } } },
    scales: {
      x: { ticks: { color:'#9fb1cc' }, grid: { display:false } },
      y: { ticks: { color:'#9fb1cc', callback:(v)=> (v*100)+'%' }, grid: { color:'rgba(255,255,255,.06)' } }
    }
  };

  charts.netVsTarget = new Chart(ctx('ch_net_vs_target'), { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: lineOpts });
  charts.grossTrend  = new Chart(ctx('ch_gross_trend'), { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: lineOpts });
  charts.netTrend    = new Chart(ctx('ch_net_trend'),   { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: lineOpts });
  charts.netnetTrend = new Chart(ctx('ch_netnet_trend'),{ type:'line', data:{ labels: dayLabels(), datasets: [] }, options: lineOpts });
  charts.tpvTrend    = new Chart(ctx('ch_tpv_trend'),   { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: lineOpts });

  charts.nnmTrend    = new Chart(ctx('ch_nnm_trend'),   { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: pctLineOpts });
  charts.nnmBar      = new Chart(ctx('ch_nnm_bar'),     { type:'bar',  data:{ labels: [], datasets: [{ label:'Net Net Margin', data: [] }] }, options: barOpts });

  charts.nmTrend     = new Chart(ctx('ch_nm_trend'),    { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: pctLineOpts });
  charts.nmBar       = new Chart(ctx('ch_nm_bar'),      { type:'bar',  data:{ labels: [], datasets: [{ label:'Net Margin', data: [] }] }, options: barOpts });

  charts.gmTrend     = new Chart(ctx('ch_gm_trend'),    { type:'line', data:{ labels: dayLabels(), datasets: [] }, options: pctLineOpts });
  charts.gmBar       = new Chart(ctx('ch_gm_bar'),      { type:'bar',  data:{ labels: [], datasets: [{ label:'Gross Margin', data: [] }] }, options: barOpts });
}

function updateCharts(){
  const { months, monthly } = aggregateMonthly(12);
  const dimCur = daysInMonth(now.getFullYear(), now.getMonth());
  const dayN = now.getDate();
  const labels = Array.from({length: dimCur}, (_,i)=> String(i+1));

  // Helper: series for last K months as MTD lines for a given extractor key
  function buildMTDSeries(key){
    const datasets = [];
    const names = ['This month','-1 month','-2 months','-3 months'];
    const baseIdx = monthly.length-1;
    for(let j=0;j<4;j++){
      const idx = baseIdx - j;
      if(idx < 0) continue;
      const mo = months[idx];
      const monthVal = monthly[idx][key];
      const dim = daysInMonth(mo.y, mo.m);
      const perDay = monthVal / dim;
      const arr = [];
      const maxD = Math.min(dayN, dim);
      for(let d=1; d<=maxD; d++) arr.push(perDay * d);
      // Pad to current month length with nulls so labels align
      while(arr.length < labels.length) arr.push(null);
      datasets.push({ label: names[j], data: arr, tension:.35, pointRadius:0, borderWidth:2 });
    }
    return datasets;
  }

  // 1) Net vs Target (current month only)
  {
    const idx = monthly.length-1;
    const netMonth = monthly[idx].net;
    const targetMonth = monthly[idx].targetNet;
    const dim = dimCur;
    const perDayActual = netMonth / dim;
    const perDayTarget = targetMonth / dim;
    const actual = []; const target = []; const projection = [];
    for(let d=1; d<=dim; d++){
      actual.push(d <= dayN ? perDayActual * d : null);
      target.push(perDayTarget * d);
      // run-rate projection (straight line using current avg per day)
      const runRate = (perDayActual * dayN) / dayN; // == perDayActual
      projection.push(runRate * d);
    }
    charts.netVsTarget.data.labels = labels;
    charts.netVsTarget.data.datasets = [
      { label: 'Actual', data: actual, tension:.35, pointRadius:0, borderWidth:2 },
      { label: 'Target', data: target, borderDash:[6,6], tension:.35, pointRadius:0, borderWidth:2 },
      { label: 'Projection', data: projection, borderDash:[2,4], tension:.35, pointRadius:0, borderWidth:2 }
    ];

    const mtdActual = perDayActual * dayN;
    const projMonth = (mtdActual / dayN) * dim;
    document.getElementById('kpi_mtd_net').textContent = 'S$ ' + fmt(mtdActual);
    document.getElementById('kpi_target').textContent = 'S$ ' + fmt(targetMonth);
    document.getElementById('kpi_proj').textContent = 'S$ ' + fmt(projMonth);
    const attain = targetMonth>0 ? (projMonth/targetMonth) : 0;
    document.getElementById('kpi_attain').textContent = fmtPct(attain);
    charts.netVsTarget.update();
  }

  // 2) Metric trends (MTD vs prior 3 months)
  charts.grossTrend.data.labels = labels;
  charts.grossTrend.data.datasets = buildMTDSeries('gross');
  charts.grossTrend.update();

  charts.netTrend.data.labels = labels;
  charts.netTrend.data.datasets = buildMTDSeries('net');
  charts.netTrend.update();

  charts.netnetTrend.data.labels = labels;
  charts.netnetTrend.data.datasets = buildMTDSeries('netnet');
  charts.netnetTrend.update();

  charts.tpvTrend.data.labels = labels;
  charts.tpvTrend.data.datasets = buildMTDSeries('tpv');
  charts.tpvTrend.update();

  // 3) Margins – trend + MoM bars (12 months)
  const mm = monthly.map((m,i)=> ({
    nnm: m.tpv>0 ? m.netnet/m.tpv : 0,
    nm:  m.tpv>0 ? m.net/m.tpv : 0,
    gm:  m.tpv>0 ? m.gross/m.tpv : 0,
  }));
  const monthNames = months.map(m=> new Date(m.y, m.m, 1).toLocaleString('en-US', { month:'short' }))
  // Trend (MTD vs prior 3 months) uses daily values of margins -> compute from cumulative monthly components
  function buildMarginMTDSeries(numKey){
    const names = ['This month','-1 month','-2 months','-3 months'];
    const datasets = [];
    const baseIdx = monthly.length-1;
    for(let j=0;j<4;j++){
      const idx = baseIdx - j; if(idx<0) continue;
      const mo = months[idx];
      const dim = daysInMonth(mo.y, mo.m);
      const maxD = Math.min(dayN, dim);
      const tpvPD = (monthly[idx].tpv || 0) / dim;
      const numPD = (monthly[idx][numKey] || 0) / dim; // numerator per day (gross/net/netnet)
      const arr = [];
      for(let d=1; d<=maxD; d++){
        const tpvCum = tpvPD * d;
        const numCum = numPD * d;
        arr.push(tpvCum>0 ? numCum/tpvCum : 0);
      }
      while(arr.length < labels.length) arr.push(null);
      datasets.push({ label:names[j], data:arr, tension:.35, pointRadius:0, borderWidth:2 });
    }
    return datasets;
  }

  charts.nnmTrend.data.labels = labels;
  charts.nnmTrend.data.datasets = buildMarginMTDSeries('netnet');
  charts.nnmTrend.update();

  charts.nmTrend.data.labels = labels;
  charts.nmTrend.data.datasets = buildMarginMTDSeries('net');
  charts.nmTrend.update();

  charts.gmTrend.data.labels = labels;
  charts.gmTrend.data.datasets = buildMarginMTDSeries('gross');
  charts.gmTrend.update();

  charts.nnmBar.data.labels = monthNames;
  charts.nnmBar.data.datasets[0].data = mm.map(x=>x.nnm);
  charts.nnmBar.update();

  charts.nmBar.data.labels = monthNames;
  charts.nmBar.data.datasets[0].data = mm.map(x=>x.nm);
  charts.nmBar.update();

  charts.gmBar.data.labels = monthNames;
  charts.gmBar.data.datasets[0].data = mm.map(x=>x.gm);
  charts.gmBar.update();
}

function hookFilters(){
  const selIds = ['f_country','f_partnerCat','f_agreement','f_industry','f_cpm','f_product','f_lead','f_mkt','f_age'];
  selIds.forEach(id=> document.getElementById(id).addEventListener('change', updateCharts));
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    selIds.forEach(id=> document.getElementById(id).value = 'All');
    updateCharts();
  });
}

function init(){
  const tzDate = new Date();
  document.getElementById('asOf').textContent = `As of ${tzDate.toLocaleDateString('en-SG', { year:'numeric', month:'long', day:'numeric' })}`;
  buildCharts();
  hookFilters();
  updateCharts();
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
